<!-- itcj/apps/helpdesk/templates/admin/assign_tickets.html -->
{% extends "helpdesk/base_helpdesk.html" %}

{% block title %}Asignación de Tickets{% endblock %}

{% block header_title %}Panel de Asignación{% endblock %}
{% block header_subtitle %}Centro de Cómputo - Gestión de Tickets{% endblock %}

{% block header_actions %}
<div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()">
        <i class="fas fa-sync me-2"></i>Actualizar
    </button>
    <span class="badge bg-danger" id="urgentBadge" style="display: none;">
        <i class="fas fa-exclamation-triangle me-1"></i>
        <span id="urgentCount">0</span> Urgentes
    </span>
</div>
{% endblock %}

{% block content %}

<!-- Dashboard Overview Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
        <div class="card border-0 shadow-sm border-start border-danger border-4 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-semibold">Pendientes</small>
                        <h2 class="text-danger mb-0 fw-bold" id="pendingCount">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </h2>
                    </div>
                    <i class="fas fa-clock fa-2x text-danger opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
        <div class="card border-0 shadow-sm border-start border-warning border-4 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-semibold">Sin Asignar</small>
                        <h2 class="text-warning mb-0 fw-bold" id="unassignedCount">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </h2>
                    </div>
                    <i class="fas fa-user-slash fa-2x text-warning opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
        <div class="card border-0 shadow-sm border-start border-primary border-4 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-semibold">En Progreso</small>
                        <h2 class="text-primary mb-0 fw-bold" id="inProgressCount">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </h2>
                    </div>
                    <i class="fas fa-cog fa-2x text-primary opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card border-0 shadow-sm border-start border-success border-4 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-semibold">Hoy</small>
                        <h2 class="text-success mb-0 fw-bold" id="todayCount">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </h2>
                    </div>
                    <i class="fas fa-calendar-day fa-2x text-success opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Urgent Tickets Alert -->
<div class="alert alert-danger border-0 shadow-sm d-none mb-4" id="urgentAlert">
    <div class="d-flex align-items-start">
        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="alert-heading mb-0">
                    <i class="fas fa-fire me-2"></i>Tickets Urgentes - Atención Inmediata
                </h5>
                <button class="btn btn-sm btn-outline-danger" id="toggleUrgentAlert" title="Ocultar alerta">
                    <i class="fas fa-chevron-up" id="toggleUrgentIcon"></i>
                </button>
            </div>
            <div id="urgentAlertContent">
                <p class="mb-3">Los siguientes tickets requieren asignación inmediata</p>
                <div id="urgentTicketsList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Main Tabs -->
<ul class="nav nav-tabs nav-fill mb-4" id="assignmentTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button">
            <i class="fas fa-inbox me-2"></i>Cola de Tickets
            <span class="badge bg-danger ms-2" id="queueBadge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
            <i class="fas fa-tasks me-2"></i>En Proceso
            <span class="badge bg-primary ms-2" id="activeBadge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="technicians-tab" data-bs-toggle="tab" data-bs-target="#technicians" type="button">
            <i class="fas fa-users me-2"></i>Técnicos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">
            <i class="fas fa-chart-bar me-2"></i>Estadísticas
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="assignmentTabContent">
    
    <!-- Queue Tab (Pending Tickets) -->
    <div class="tab-pane fade show active" id="queue" role="tabpanel">
        
        <!-- Filters -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small fw-semibold">Área</label>
                        <select class="form-select form-select-sm" id="filterArea">
                            <option value="">Todas</option>
                            <option value="DESARROLLO">Desarrollo</option>
                            <option value="SOPORTE">Soporte</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-semibold">Prioridad</label>
                        <select class="form-select form-select-sm" id="filterPriority">
                            <option value="">Todas</option>
                            <option value="URGENTE">Urgente</option>
                            <option value="ALTA">Alta</option>
                            <option value="MEDIA">Media</option>
                            <option value="BAJA">Baja</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-semibold">Buscar</label>
                        <input type="text" class="form-control form-control-sm" id="searchQueue" 
                               placeholder="Buscar por título, usuario o ubicación...">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tickets Queue -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Tickets Pendientes de Asignación
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadPendingTickets()">
                        <i class="fas fa-sync me-2"></i>Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="queueList">
                    <!-- Loading state -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-3">Cargando cola de tickets...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Tickets Tab -->
    <div class="tab-pane fade" id="active" role="tabpanel">
        
        <!-- Sub-tabs for areas -->
        <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#active-all">
                    Todos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#active-desarrollo">
                    Desarrollo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#active-soporte">
                    Soporte
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <div class="tab-pane fade show active" id="active-all">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div id="activeList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-3">Cargando tickets activos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="active-desarrollo">
                <div id="activeDesarrolloList"></div>
            </div>
            <div class="tab-pane fade" id="active-soporte">
                <div id="activeSoporteList"></div>
            </div>
        </div>
    </div>
    
    <!-- Technicians Tab -->
    <div class="tab-pane fade" id="technicians" role="tabpanel">
        <div class="row">
            <!-- Desarrollo Team -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-laptop-code me-2"></i>Equipo Desarrollo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="techDesarrolloList">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Soporte Team -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-wrench me-2"></i>Equipo Soporte
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="techSoporteList">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-info"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Tab -->
    <div class="tab-pane fade" id="stats" role="tabpanel">
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 fw-bold">Resumen del Día</h6>
                    </div>
                    <div class="card-body" id="todayStats">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 fw-bold">Por Departamento</h6>
                    </div>
                    <div class="card-body" id="deptStats">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 fw-bold">Tiempos Promedio</h6>
                    </div>
                    <div class="card-body" id="timeStats">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block modals %}

<!-- Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Asignar Ticket
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Ticket Info -->
                <div id="assignTicketInfo" class="p-3 bg-light rounded mb-3">
                    <!-- Se llenará dinámicamente -->
                </div>
                
                <!-- Assignment Type -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo de Asignación</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="assignType" id="assignUser" value="user" checked>
                        <label class="btn btn-outline-primary" for="assignUser">
                            <i class="fas fa-user me-2"></i>Técnico Individual
                        </label>
                        
                        <input type="radio" class="btn-check" name="assignType" id="assignTeam" value="team">
                        <label class="btn btn-outline-primary" for="assignTeam">
                            <i class="fas fa-users me-2"></i>Equipo Completo
                        </label>
                    </div>
                </div>
                
                <!-- Select Technician -->
                <div class="mb-3" id="selectTechnicianContainer">
                    <label for="technicianSelect" class="form-label fw-bold">
                        Seleccionar Técnico
                    </label>
                    <select class="form-select" id="technicianSelect">
                        <option value="">Cargando técnicos...</option>
                    </select>
                    <small class="form-text text-muted" id="technicianLoad">
                        <!-- Se mostrará la carga de trabajo -->
                    </small>
                </div>
                
                <!-- Select Team -->
                <div class="mb-3 d-none" id="selectTeamContainer">
                    <label for="teamSelect" class="form-label fw-bold">
                        Seleccionar Equipo
                    </label>
                    <select class="form-select" id="teamSelect">
                        <option value="">Selecciona un equipo...</option>
                        <option value="desarrollo">Equipo Desarrollo</option>
                        <option value="soporte">Equipo Soporte</option>
                    </select>
                </div>
                
                <!-- Reason (optional) -->
                <div class="mb-3">
                    <label for="assignmentReason" class="form-label">
                        Notas (opcional)
                    </label>
                    <textarea class="form-control" id="assignmentReason" rows="2"
                              placeholder="Instrucciones especiales o contexto adicional..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmAssign">
                    <i class="fas fa-paper-plane me-2"></i>Asignar Ticket
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reassignment Modal -->
<div class="modal fade" id="reassignmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Reasignar Ticket
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reassignTicketInfo" class="p-3 bg-light rounded mb-3"></div>

                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    Este ticket ya está asignado. Al reasignarlo se notificará al técnico actual.
                </div>

                <div class="mb-3">
                    <label for="newTechnicianSelect" class="form-label fw-bold">
                        Nuevo Técnico/Equipo
                    </label>
                    <select class="form-select" id="newTechnicianSelect">
                        <option value="">Selecciona...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="reassignReason" class="form-label fw-bold">
                        Razón de Reasignación
                    </label>
                    <textarea class="form-control" id="reassignReason" rows="3"
                              placeholder="¿Por qué se reasigna este ticket?" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnConfirmReassign">
                    <i class="fas fa-exchange-alt me-2"></i>Reasignar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit/Preview Ticket Modal -->
<div class="modal fade" id="editTicketModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Vista Previa / Editar Ticket
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="row">
                    <!-- Columna Izquierda: Vista Previa (Solo Lectura) -->
                    <div class="col-md-5 border-end">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-eye me-2"></i>Informacion del Ticket
                        </h6>

                        <!-- Numero de Ticket y Estado -->
                        <div class="mb-3" id="editTicketHeader">
                            <!-- Se llena dinamicamente -->
                        </div>

                        <!-- Info del Solicitante -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <small class="fw-bold"><i class="fas fa-user me-2"></i>Solicitante</small>
                            </div>
                            <div class="card-body py-2" id="editTicketRequester">
                                <!-- Se llena dinamicamente -->
                            </div>
                        </div>

                        <!-- Fechas -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <small class="fw-bold"><i class="fas fa-calendar me-2"></i>Fechas</small>
                            </div>
                            <div class="card-body py-2" id="editTicketDates">
                                <!-- Se llena dinamicamente -->
                            </div>
                        </div>

                        <!-- Archivos Adjuntos -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <small class="fw-bold"><i class="fas fa-paperclip me-2"></i>Archivos Adjuntos</small>
                            </div>
                            <div class="card-body py-2" id="editTicketAttachments">
                                <div class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Campos Personalizados (Solo Lectura) -->
                        <div class="card mb-3" id="editTicketCustomFieldsContainer" style="display: none;">
                            <div class="card-header py-2 bg-light">
                                <small class="fw-bold"><i class="fas fa-list-alt me-2"></i>Campos Adicionales</small>
                            </div>
                            <div class="card-body py-2" id="editTicketCustomFields">
                                <!-- Se llena dinamicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Campos Editables -->
                    <div class="col-md-7">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-pencil-alt me-2"></i>Editar Campos
                        </h6>

                        <div class="alert alert-info py-2 mb-3">
                            <small><i class="fas fa-info-circle me-2"></i>
                            Solo los tickets en estado <strong>PENDING</strong> pueden editarse.
                            Al cambiar la categoria, los campos personalizados se borraran.
                            </small>
                        </div>

                        <!-- Area y Categoria -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editArea" class="form-label fw-bold">Area</label>
                                <select class="form-select" id="editArea">
                                    <option value="DESARROLLO">Desarrollo</option>
                                    <option value="SOPORTE">Soporte</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editCategory" class="form-label fw-bold">Categoria</label>
                                <select class="form-select" id="editCategory">
                                    <option value="">Cargando...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Prioridad -->
                        <div class="mb-3">
                            <label for="editPriority" class="form-label fw-bold">Prioridad</label>
                            <select class="form-select" id="editPriority">
                                <option value="URGENTE">Urgente</option>
                                <option value="ALTA">Alta</option>
                                <option value="MEDIA">Media</option>
                                <option value="BAJA">Baja</option>
                            </select>
                        </div>

                        <!-- Titulo -->
                        <div class="mb-3">
                            <label for="editTitle" class="form-label fw-bold">Titulo</label>
                            <input type="text" class="form-control" id="editTitle"
                                   placeholder="Minimo 5 caracteres" minlength="5" maxlength="200">
                            <small class="form-text text-muted">
                                <span id="editTitleCount">0</span>/200 caracteres
                            </small>
                        </div>

                        <!-- Descripcion -->
                        <div class="mb-3">
                            <label for="editDescription" class="form-label fw-bold">Descripcion</label>
                            <textarea class="form-control" id="editDescription" rows="4"
                                      placeholder="Minimo 20 caracteres" minlength="20"></textarea>
                            <small class="form-text text-muted">
                                <span id="editDescriptionCount">0</span> caracteres (minimo 20)
                            </small>
                        </div>

                        <!-- Ubicacion -->
                        <div class="mb-3">
                            <label for="editLocation" class="form-label fw-bold">Ubicacion</label>
                            <input type="text" class="form-control" id="editLocation"
                                   placeholder="Ej: Edificio A, Oficina 101">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
                <button type="button" class="btn btn-info" id="btnSaveTicketEdit">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='helpdesk/css/admin/assign_tickets.css') }}?v={{ sv('helpdesk', 'css/admin/assign_tickets.css') }}">
{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='helpdesk/js/admin/assign_tickets.js') }}?v={{ sv('helpdesk', 'js/admin/assign_tickets.js') }}"></script>
{% endblock %}