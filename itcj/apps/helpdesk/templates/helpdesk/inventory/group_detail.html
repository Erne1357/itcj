{% extends "helpdesk/base_helpdesk.html" %}

{% block title %}Detalle de Grupo - Help-Desk ITCJ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='helpdesk/css/inventory/group_detail.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Botón Volver -->
    <div class="mb-3">
        <a href="{{ url_for('helpdesk_pages.inventory_pages.groups_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Grupos
        </a>
    </div>

    <!-- Loading -->
    <div id="loading-container" class="text-center py-5">
        <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
        <p class="text-muted">Cargando grupo...</p>
    </div>

    <!-- Contenido Principal -->
    <div id="main-content" style="display: none;">
        
        <!-- Header del Grupo -->
        <div class="group-header shadow">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="mb-2">
                        <i id="group-icon" class="fas fa-layer-group mr-2"></i>
                        <span id="group-name">Cargando...</span>
                    </h1>
                    <p class="mb-0 opacity-75" id="group-description"></p>
                    <div class="mt-2">
                        <span class="badge badge-light mr-2" id="group-type-badge"></span>
                        <span class="text-white-50">
                            <i class="fas fa-building mr-1"></i>
                            <span id="group-department"></span>
                        </span>
                    </div>
                </div>
                <div>
                    {% if 'admin' in user_roles or 'department_head' in user_roles %}
                    <button class="btn btn-light" onclick="editGroup()">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger" onclick="confirmDeleteGroup()">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Ubicación -->
            <div class="mt-3" id="location-info" style="display: none;">
                <small>
                    <i class="fas fa-map-marker-alt mr-1"></i>
                    <span id="location-text"></span>
                </small>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card shadow h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-boxes fa-2x text-primary"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Equipos Totales
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-total">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card shadow h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-layer-group fa-2x text-success"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Capacidad Total
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-capacity">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card shadow h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-chart-pie fa-2x text-warning"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Ocupación
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-occupancy">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card shadow h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                <i class="fas fa-tags fa-2x text-info"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Categorías
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-categories">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capacidades por Categoría -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-sliders-h"></i> Capacidades por Categoría
                </h6>
            </div>
            <div class="card-body">
                <div id="capacities-list">
                    <!-- Se llenará con JavaScript -->
                </div>
            </div>
        </div>

        <!-- Equipos del Grupo -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-boxes"></i> Equipos en este Grupo
                </h6>
                <div>
                    {% if 'admin' in user_roles or 'department_head' in user_roles %}
                    <button class="btn btn-sm btn-success" onclick="openAddEquipmentModal()">
                        <i class="fas fa-plus-circle"></i> Agregar Equipos
                    </button>
                    <button class="btn btn-sm btn-danger" id="remove-selected-btn" style="display: none;" onclick="removeSelectedEquipment()">
                        <i class="fas fa-trash"></i> Remover Seleccionados
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <!-- Filtros rápidos -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input 
                            type="text" 
                            class="form-control form-control-sm" 
                            id="equipment-search" 
                            placeholder="Buscar equipos..."
                        >
                    </div>
                    <div class="col-md-3">
                        <select class="form-control form-control-sm" id="equipment-category-filter">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control form-control-sm" id="equipment-status-filter">
                            <option value="">Todos los estados</option>
                            <option value="ACTIVE">Activo</option>
                            <option value="MAINTENANCE">Mantenimiento</option>
                            <option value="DAMAGED">Dañado</option>
                        </select>
                    </div>
                </div>

                <!-- Tabla de equipos -->
                <div id="equipment-loading" class="text-center py-3">
                    <i class="fas fa-spinner fa-spin"></i> Cargando equipos...
                </div>

                <div id="equipment-table-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover" id="equipment-table">
                            <thead>
                                <tr>
                                    {% if 'admin' in user_roles or 'department_head' in user_roles %}
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="select-all-equipment" class="equipment-checkbox">
                                    </th>
                                    {% endif %}
                                    <th>N° Inventario</th>
                                    <th>Categoría</th>
                                    <th>Equipo</th>
                                    <th>Estado</th>
                                    <th>Ubicación</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="equipment-empty" style="display: none;" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay equipos en este grupo</p>
                    {% if 'admin' in user_roles or 'department_head' in user_roles %}
                    <button class="btn btn-primary" onclick="openAddEquipmentModal()">
                        <i class="fas fa-plus-circle"></i> Agregar Equipos
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal: Agregar Equipos -->
<div class="modal fade" id="addEquipmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Agregar Equipos al Grupo
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="available-search" 
                            placeholder="Buscar equipos disponibles..."
                        >
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="available-category-filter">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary btn-block" onclick="loadAvailableEquipment()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>

                <!-- Lista de equipos disponibles -->
                <div id="available-equipment-loading" class="text-center py-3">
                    <i class="fas fa-spinner fa-spin"></i> Cargando equipos disponibles...
                </div>

                <div id="available-equipment-container" style="display: none;">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="thead-light sticky-top">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="select-all-available" class="equipment-checkbox">
                                    </th>
                                    <th>N° Inventario</th>
                                    <th>Categoría</th>
                                    <th>Equipo</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="available-equipment-tbody">
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <span id="selected-count">0</span> equipo(s) seleccionado(s)
                        </small>
                    </div>
                </div>

                <div id="available-equipment-empty" style="display: none;" class="text-center py-3">
                    <p class="text-muted">No hay equipos disponibles para este grupo</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedEquipment()">
                    <i class="fas fa-plus"></i> Agregar Seleccionados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const GROUP_ID = {{ group_id }};
</script>
<script src="{{ url_for('static', filename='helpdesk/js/inventory/group_detail.js') }}?v={{ sv('helpdesk', 'js/inventory/group_detail.js') }}"></script>
{% endblock %}