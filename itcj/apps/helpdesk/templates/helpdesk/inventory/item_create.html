{% extends "helpdesk/base_helpdesk.html" %}

{% block title %}Registrar Equipo - Help-Desk ITCJ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='helpdesk/css/inventory/item_create.css') }}?v={{ sv('helpdesk', 'css/inventory/item_create.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-plus-circle fa-fw"></i> 
                <span id="page-title">Registrar Nuevo Equipo</span>
            </h1>
            <p class="text-muted mb-0" id="page-subtitle">Complete la información del equipo para agregarlo al inventario</p>
        </div>
        <div>
            <a href="{{ url_for('helpdesk_pages.inventory_pages.items_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Lista
            </a>
        </div>
    </div>

    <!-- Selector de Modo -->
    <div class="mode-selector text-center">
        <div class="btn-group btn-group-lg" role="group">
            <button type="button" class="mode-btn active" id="mode-individual-btn" onclick="switchMode('individual')">
                <i class="fas fa-box mr-2"></i>
                Registro Individual
            </button>
            <button type="button" class="mode-btn" id="mode-bulk-btn" onclick="switchMode('bulk')">
                <i class="fas fa-boxes mr-2"></i>
                Registro Masivo
            </button>
        </div>
        <p class="text-muted mt-2 mb-0">
            <small id="mode-description">Registra un equipo con toda su información detallada</small>
        </p>
    </div>

    <div class="row">
        <!-- Formulario Principal -->
        <div class="col-lg-8">
            
            <!-- ==================== MODO INDIVIDUAL ==================== -->
            <form id="create-item-form" style="display: block;">
                
                <!-- SECCIÓN 1: Categoría y Número -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-tag"></i> Categoría y Clasificación
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="required-field">Categoría</label>
                                <select class="form-control" id="category-id" name="category_id" required>
                                    <option value="">Seleccionar categoría...</option>
                                    <!-- Se llenará con JavaScript -->
                                </select>
                                <small class="form-text text-muted">
                                    Tipo de equipo a registrar
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Número de Inventario</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="inventory-number" 
                                    name="inventory_number" 
                                    placeholder="Se generará automáticamente"
                                    readonly
                                >
                                <small class="form-text text-muted">
                                    Se asignará automáticamente al guardar
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Preview de categoría -->
                    <div id="category-preview" style="display: none;" class="text-center">
                        <div class="category-icon-preview">
                            <i id="category-icon-display" class="fas fa-box text-primary"></i>
                        </div>
                        <p id="category-description" class="text-muted"></p>
                    </div>
                </div>

                <!-- SECCIÓN 2: Información Básica -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-info-circle"></i> Información Básica
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Marca</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="brand" 
                                    name="brand" 
                                    placeholder="HP, Dell, Lenovo..."
                                >
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Modelo</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="model" 
                                    name="model" 
                                    placeholder="OptiPlex 7090, Vostro 3681..."
                                >
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Número de Serie</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="serial-number" 
                            name="serial_number" 
                            placeholder="Número de serie del fabricante"
                        >
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Debe ser único en el sistema
                        </small>
                    </div>
                </div>

                <!-- SECCIÓN 3: Especificaciones Técnicas (Dinámico) -->
                <div class="form-section" id="specs-section" style="display: none;">
                    <div class="form-section-title">
                        <i class="fas fa-microchip"></i> Especificaciones Técnicas
                    </div>
                    
                    <div id="dynamic-specs-container">
                        <!-- Se llenará dinámicamente según la categoría -->
                    </div>
                </div>

                <!-- SECCIÓN 4: Ubicación y Asignación -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-map-marker-alt"></i> Ubicación y Asignación
                    </div>

                    <div class="form-group">
                        <label class="required-field">Departamento</label>
                        <select class="form-control" id="department-id" name="department_id" required>
                            <option value="">Seleccionar departamento...</option>
                            <!-- Se llenará con JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ubicación Específica</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="location-detail" 
                            name="location_detail" 
                            placeholder="Aula 201, Oficina del Director, Lab 3 - Estación 5..."
                        >
                    </div>

                    <div class="custom-control custom-checkbox mb-3">
                        <input 
                            type="checkbox" 
                            class="custom-control-input" 
                            id="assign-to-user-check"
                        >
                        <label class="custom-control-label" for="assign-to-user-check">
                            Asignar a un usuario específico
                        </label>
                    </div>

                    <div id="user-assignment-section" style="display: none;">
                        <div class="form-group">
                            <label>Usuario</label>
                            <select class="form-control" id="assigned-to-user-id" name="assigned_to_user_id">
                                <option value="">Seleccionar usuario...</option>
                                <!-- Se llenará dinámicamente según departamento -->
                            </select>
                            <small class="form-text text-muted">
                                Dejar vacío para que sea global del departamento
                            </small>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 5: Garantía y Mantenimiento -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-shield-alt"></i> Garantía y Mantenimiento
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Fecha de Adquisición</label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="acquisition-date" 
                                    name="acquisition_date"
                                >
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Vencimiento de Garantía</label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="warranty-expiration" 
                                    name="warranty_expiration"
                                >
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Frecuencia Mantenimiento (días)</label>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="maintenance-frequency" 
                                    name="maintenance_frequency_days" 
                                    placeholder="180"
                                    min="1"
                                >
                                <small class="form-text text-muted">Ej: 180 (6 meses)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 6: Observaciones -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-sticky-note"></i> Observaciones
                    </div>

                    <div class="form-group">
                        <label>Notas adicionales</label>
                        <textarea 
                            class="form-control" 
                            id="notes" 
                            name="notes" 
                            rows="4" 
                            placeholder="Cualquier información adicional relevante sobre el equipo..."
                        ></textarea>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="d-flex justify-content-between mb-5">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                        <i class="fas fa-save"></i> Registrar Equipo
                    </button>
                </div>

            </form>

            <!-- ==================== MODO MASIVO ==================== -->
            <form id="bulk-create-form" style="display: none;">
                
                <!-- SECCIÓN: Configuración General -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-cog"></i> Configuración del Registro Masivo
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Registro Masivo:</strong> Todos los equipos compartirán la misma categoría, marca y modelo. 
                        Los números de inventario se generarán automáticamente de forma secuencial.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="required-field">Categoría</label>
                                <select class="form-control" id="bulk-category-id" required>
                                    <option value="">Seleccionar categoría...</option>
                                    <!-- Se llenará con JavaScript -->
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="required-field">Cantidad de Equipos</label>
                                <input 
                                    type="number" 
                                    class="form-control form-control-lg" 
                                    id="bulk-quantity" 
                                    min="2" 
                                    max="100" 
                                    value="10"
                                    required
                                >
                                <small class="form-text text-muted">
                                    Mínimo 2, máximo 100 equipos
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Marca (Común)</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="bulk-brand" 
                                    placeholder="HP, Dell, Lenovo..."
                                >
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Modelo (Común)</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="bulk-model" 
                                    placeholder="OptiPlex 7090, Vostro 3681..."
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: Asignación -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-map-marker-alt"></i> Ubicación y Destino
                    </div>

                    <div class="form-group">
                        <label>Destino de los Equipos</label>
                        <select class="form-control" id="bulk-destination-type">
                            <option value="pending">Dejar Pendientes (Limbo)</option>
                            <option value="department">Asignar a Departamento</option>
                            <option value="group">Asignar a Grupo/Salón</option>
                        </select>
                        <small class="form-text text-muted">
                            Define dónde se ubicarán los equipos registrados
                        </small>
                    </div>

                    <!-- Asignación a Departamento -->
                    <div id="bulk-department-section" style="display: none;">
                        <div class="form-group">
                            <label class="required-field">Departamento</label>
                            <select class="form-control" id="bulk-department-id">
                                <option value="">Seleccionar departamento...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ubicación Específica</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="bulk-location-detail" 
                                placeholder="Ej: Laboratorio de Sistemas"
                            >
                        </div>
                    </div>

                    <!-- Asignación a Grupo -->
                    <div id="bulk-group-section" style="display: none;">
                        <div class="form-group">
                            <label class="required-field">Departamento del Grupo</label>
                            <select class="form-control" id="bulk-group-department-id">
                                <option value="">Seleccionar departamento...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required-field">Grupo/Salón</label>
                            <select class="form-control" id="bulk-group-id">
                                <option value="">Primero selecciona un departamento</option>
                            </select>
                            <small class="form-text text-muted">
                                Los equipos se agregarán a este grupo automáticamente
                            </small>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: Información Adicional -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-sticky-note"></i> Información Adicional (Opcional)
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Fecha de Adquisición</label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="bulk-acquisition-date"
                                >
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Vencimiento de Garantía</label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="bulk-warranty-expiration"
                                >
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observaciones Generales</label>
                        <textarea 
                            class="form-control" 
                            id="bulk-notes" 
                            rows="3"
                            placeholder="Notas que aplicarán a todos los equipos..."
                        ></textarea>
                    </div>
                </div>

                <!-- Botones -->
                <div class="d-flex justify-content-between mb-5">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success btn-lg" id="bulk-submit-btn">
                        <i class="fas fa-boxes"></i> Registrar <span id="bulk-btn-quantity">0</span> Equipos
                    </button>
                </div>

            </form>

        </div>

        <!-- Panel Lateral - Preview y Ayuda -->
        <div class="col-lg-4">
            
            <!-- PREVIEW MODO INDIVIDUAL -->
            <div id="individual-preview">
                <!-- Preview de Número de Inventario -->
                <div class="card shadow mb-4">
                    <div class="card-body inventory-preview">
                        <div class="text-uppercase mb-2" style="font-size: 0.9rem; opacity: 0.9;">
                            Número de Inventario
                        </div>
                        <div class="number" id="preview-inventory-number">
                            ---
                        </div>
                        <div class="mt-2" style="font-size: 0.85rem; opacity: 0.8;">
                            Se generará al guardar
                        </div>
                    </div>
                </div>

                <!-- Estado Inicial -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-toggle-on"></i> Estado Inicial
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5 class="text-success mb-0">ACTIVO</h5>
                            <p class="text-muted mb-0">
                                <small>El equipo se registrará con estado activo</small>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tips -->
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-info">
                            <i class="fas fa-lightbulb"></i> Consejos
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success mr-2"></i>
                                <small>El número de serie debe ser único</small>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success mr-2"></i>
                                <small>Las especificaciones ayudan al soporte técnico</small>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success mr-2"></i>
                                <small>La ubicación facilita localizar el equipo</small>
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-check text-success mr-2"></i>
                                <small>Registra la garantía para recibir alertas</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- PREVIEW MODO MASIVO -->
            <div id="bulk-preview" style="display: none;">
                <!-- Preview de Cantidad -->
                <div class="card shadow mb-4">
                    <div class="card-body text-center">
                        <div class="text-uppercase mb-2" style="font-size: 0.9rem; opacity: 0.7;">
                            Equipos a Registrar
                        </div>
                        <div class="quantity-preview" id="preview-bulk-quantity">
                            0
                        </div>
                        <div class="mt-2" style="font-size: 0.85rem; opacity: 0.7;">
                            equipos del mismo tipo
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-success">
                            <i class="fas fa-list-check"></i> Resumen
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="bulk-summary">
                            <p class="text-muted"><small>Configura el registro masivo para ver el resumen</small></p>
                        </div>
                    </div>
                </div>

                <!-- Tips Masivo -->
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-warning">
                            <i class="fas fa-exclamation-triangle"></i> Importante
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-warning mr-2"></i>
                                <small>Los números se generan automáticamente</small>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-warning mr-2"></i>
                                <small>Todos tendrán la misma categoría</small>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-warning mr-2"></i>
                                <small>Puedes asignarlos después individualmente</small>
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-check text-warning mr-2"></i>
                                <small>Máximo 100 equipos por operación</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal: Éxito Individual -->
<div class="modal fade" id="successModal" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                <h3 class="mb-3">¡Equipo Registrado!</h3>
                <p class="text-muted mb-4">
                    El equipo <strong id="success-inventory-number"></strong> 
                    ha sido registrado exitosamente en el inventario.
                </p>
                <div class="d-flex justify-content-center gap-2">
                    <a href="" id="view-item-link" class="btn btn-primary">
                        <i class="fas fa-eye"></i> Ver Equipo
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                        <i class="fas fa-plus"></i> Registrar Otro
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Éxito Masivo -->
<div class="modal fade" id="bulkSuccessModal" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                <h3 class="mb-3">¡Registro Masivo Completado!</h3>
                <p class="text-muted mb-4">
                    Se han registrado exitosamente <strong id="bulk-success-count">0</strong> equipos
                </p>
                
                <div id="bulk-success-details" class="text-left mb-4" style="max-height: 300px; overflow-y: auto;">
                    <!-- Se llenará con JavaScript -->
                </div>

                <div class="d-flex justify-content-center gap-2">
                    <a href="/help-desk/inventory/items" class="btn btn-primary">
                        <i class="fas fa-list"></i> Ver Inventario
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                        <i class="fas fa-plus"></i> Registrar Más
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Progreso -->
<div class="modal fade" id="progressModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <i class="fas fa-cog fa-spin fa-3x text-primary mb-4"></i>
                <h5 class="mb-3">Registrando Equipos...</h5>
                <div class="progress mb-3" style="height: 25px;">
                    <div 
                        id="progress-bar" 
                        class="progress-bar progress-bar-striped progress-bar-animated" 
                        role="progressbar" 
                        style="width: 0%"
                    >
                        <span id="progress-text">0%</span>
                    </div>
                </div>
                <p class="text-muted mb-0">
                    <span id="progress-current">0</span> / <span id="progress-total">0</span> equipos
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const BULK_MODE = {{ 'true' if bulk_mode else 'false' }};
</script>
<script src="{{ url_for('static', filename='helpdesk/js/inventory/item_create.js') }}?v={{ sv('helpdesk', 'js/inventory/item_create.js') }}"></script>
{% endblock %}