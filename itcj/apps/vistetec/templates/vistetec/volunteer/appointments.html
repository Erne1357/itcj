{% extends "vistetec/base.html" %}
{% block title %}Gestión de Citas{% endblock %}

{% block extra_css %}
<style>
    .nav-pills .nav-link {
        color: #6c757d;
        border-radius: 0.5rem;
    }
    .nav-pills .nav-link.active {
        background-color: #8B1538;
    }
    .appointment-item {
        border-left: 4px solid #8B1538;
        transition: all 0.2s;
    }
    .appointment-item.status-attended {
        border-left-color: #0dcaf0;
    }
    .appointment-item.status-completed {
        border-left-color: #198754;
    }
    .appointment-item.status-no_show {
        border-left-color: #6c757d;
    }
    .slot-item {
        border-left: 4px solid #8B1538;
    }
    .slot-item.inactive {
        border-left-color: #dc3545;
        opacity: 0.6;
    }
    .garment-mini {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
    }
    .garment-mini-placeholder {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fdf2f4;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h2 class="fw-bold mb-1">Gestión de Citas</h2>
            <p class="text-muted mb-0">Administra tus horarios y atiende citas</p>
        </div>
        <button class="btn" id="btnNewSlot" style="background-color: #8B1538; color: white;">
            <i class="bi bi-plus-circle me-1"></i>Nuevo horario
        </button>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-4" id="appointmentsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="today-tab" data-bs-toggle="pill" data-bs-target="#today" type="button">
                <i class="bi bi-calendar-day me-1"></i>Citas de hoy
                <span class="badge bg-light text-dark ms-1" id="todayCount">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="slots-tab" data-bs-toggle="pill" data-bs-target="#slots" type="button">
                <i class="bi bi-clock me-1"></i>Mis horarios
            </button>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="appointmentsContent">
        <!-- Citas de hoy -->
        <div class="tab-pane fade show active" id="today" role="tabpanel">
            <div id="todayList">
                <!-- Se llena con JS -->
            </div>
            <div id="todayEmpty" class="text-center py-5 d-none">
                <i class="bi bi-calendar-check text-muted" style="font-size: 3rem;"></i>
                <h5 class="text-muted mt-3">No hay citas para hoy</h5>
                <p class="text-muted small">Cuando tengas citas programadas, aparecerán aquí</p>
            </div>
            <div id="todayLoading" class="text-center py-4">
                <div class="spinner-border spinner-border-sm" style="color: #8B1538;"></div>
            </div>
        </div>

        <!-- Mis horarios -->
        <div class="tab-pane fade" id="slots" role="tabpanel">
            <div id="slotsList">
                <!-- Se llena con JS -->
            </div>
            <div id="slotsEmpty" class="text-center py-5 d-none">
                <i class="bi bi-clock text-muted" style="font-size: 3rem;"></i>
                <h5 class="text-muted mt-3">No tienes horarios creados</h5>
                <p class="text-muted small">Crea horarios para que los estudiantes puedan agendar citas</p>
                <button class="btn mt-2" style="background-color: #8B1538; color: white;" onclick="document.getElementById('btnNewSlot').click()">
                    <i class="bi bi-plus me-1"></i>Crear horario
                </button>
            </div>
            <div id="slotsLoading" class="text-center py-4">
                <div class="spinner-border spinner-border-sm" style="color: #8B1538;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal crear horario -->
<div class="modal fade" id="slotModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Nuevo horario de disponibilidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="slotForm">
                    <div class="mb-3">
                        <label class="form-label">Fecha <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="slotDate" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label">Hora inicio <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="slotStartTime" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Hora fin <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="slotEndTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Máximo de citas</label>
                        <select class="form-select" id="slotMaxAppts">
                            <option value="1">1 estudiante</option>
                            <option value="2">2 estudiantes</option>
                            <option value="3">3 estudiantes</option>
                            <option value="4">4 estudiantes</option>
                            <option value="5">5 estudiantes</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicación</label>
                        <select class="form-select" id="slotLocation">
                            <option value="">Sin especificar</option>
                            <!-- Se llena con JS -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn" id="btnSaveSlot" style="background-color: #8B1538; color: white;">
                    <span id="saveSlotText">Crear horario</span>
                    <span id="saveSlotLoading" class="d-none">
                        <span class="spinner-border spinner-border-sm me-1"></span>Creando...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal atender cita -->
<div class="modal fade" id="attendModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Atender cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="attendInfo" class="mb-4">
                    <!-- Se llena con JS -->
                </div>

                <div id="attendanceStep">
                    <p class="text-muted">¿El estudiante asistió a la cita?</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success flex-fill" id="btnAttended">
                            <i class="bi bi-check-circle me-1"></i>Sí, asistió
                        </button>
                        <button class="btn btn-outline-danger flex-fill" id="btnNoShow">
                            <i class="bi bi-x-circle me-1"></i>No asistió
                        </button>
                    </div>
                </div>

                <div id="outcomeStep" class="d-none">
                    <p class="text-muted">¿Cuál fue el resultado?</p>
                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-outline-success" data-outcome="taken">
                            <i class="bi bi-bag-check me-2"></i>Se llevó la prenda
                        </button>
                        <button class="btn btn-outline-warning" data-outcome="not_fit">
                            <i class="bi bi-arrows-angle-expand me-2"></i>No le quedó
                        </button>
                        <button class="btn btn-outline-secondary" data-outcome="declined">
                            <i class="bi bi-hand-thumbs-down me-2"></i>Decidió no llevarla
                        </button>
                    </div>
                    <div class="mt-3">
                        <label class="form-label small">Notas (opcional)</label>
                        <textarea class="form-control" id="outcomeNotes" rows="2" placeholder="Observaciones..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('vistetec_pages.static', filename='vistetec/js/volunteer_appointments.js') }}?v={{ sv('vistetec', 'js/volunteer_appointments.js') }}"></script>
{% endblock %}
