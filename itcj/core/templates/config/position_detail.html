<!-- itcj/core/templates/config/position_detail.html -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Puesto - ITCJ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('pages_core.pages_config.settings') }}" class="text-decoration-none">
                                <i class="bi bi-gear me-1"></i>Configuración
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('pages_core.pages_config.positions_management') }}"
                                class="text-decoration-none">
                                Departamentos
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="#" id="departmentBreadcrumb" class="text-decoration-none">Cargando...</a>
                        </li>
                        <li class="breadcrumb-item active" id="positionBreadcrumb">Cargando...</li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 id="positionTitle">
                            <i class="bi bi-briefcase me-2"></i><span id="positionName">Cargando...</span>
                        </h2>
                        <p class="text-muted mb-0" id="positionCode">código: ...</p>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-outline-danger" id="deletePositionBtn">
                            <i class="bi bi-trash me-1"></i>Eliminar Puesto
                        </button>
                        <button class="btn btn-primary" id="savePositionBtn">
                            <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Información General -->
            <div class="col-12 col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información General</h5>
                    </div>
                    <div class="card-body">
                        <form id="positionForm">
                            <div class="mb-3">
                                <label for="positionTitleInput" class="form-label">Título del Puesto *</label>
                                <input type="text" class="form-control" id="positionTitleInput" required>
                            </div>

                            <div class="mb-3">
                                <label for="positionDescription" class="form-label">Descripción</label>
                                <textarea class="form-control" id="positionDescription" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="positionEmail" class="form-label">Email Oficial</label>
                                <input type="email" class="form-control" id="positionEmail">
                                <small class="form-text text-muted">Email del puesto (solo para puestos únicos)</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allowsMultiple">
                                    <label class="form-check-label" for="allowsMultiple">
                                        Permitir múltiples usuarios
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isActive">
                                    <label class="form-check-label" for="isActive">
                                        Puesto activo
                                    </label>
                                </div>
                            </div>

                            <div class="alert alert-info" id="codeInfo">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Código:</strong> <span id="displayCode"></span>
                                <br>
                                <small>El código no puede ser modificado</small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Usuarios Asignados -->
            <div class="col-12 col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Usuarios Asignados</h5>
                        <button class="btn btn-sm btn-primary" id="assignUserBtn">
                            <i class="bi bi-person-plus me-1"></i>Asignar Usuario
                        </button>
                    </div>
                    <div class="card-body" id="usersListContainer">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aplicaciones y Permisos -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-app me-2"></i>Aplicaciones y Permisos</h5>
                        <button class="btn btn-sm btn-primary" id="manageAppsBtn">
                            <i class="bi bi-gear me-1"></i>Gestionar Aplicaciones
                        </button>
                    </div>
                    <div class="card-body" id="appsContainer">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Asignar Usuario -->
    <div class="modal fade" id="assignUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asignar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="assignUserForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="userSearch" class="form-label">Buscar Usuario</label>
                            <input type="text" class="form-control" id="userSearch" placeholder="Buscar por nombre...">
                        </div>
                        <div class="mb-3">
                            <label for="userSelect" class="form-label">Usuario *</label>
                            <select class="form-select" id="userSelect" required>
                                <option value="">Seleccionar usuario...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="mb-3">
                            <label for="assignmentNotes" class="form-label">Notas</label>
                            <textarea class="form-control" id="assignmentNotes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Asignar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- itcj/core/templates/config/position_detail.html -->
    <!-- AGREGAR después del modal de Asignar Usuario, ANTES de los toasts -->

    <!-- Modal: Confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Confirmar Acción
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage" class="mb-0">¿Estás seguro de realizar esta acción?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirmActionBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Gestionar Apps/Roles -->
    <div class="modal fade" id="manageAppsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-apps me-2"></i>Gestionar Aplicaciones
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Lista de Apps -->
                        <div class="col-12 col-md-4">
                            <h6>Aplicaciones Disponibles</h6>
                            <div class="list-group" id="appsListModal">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Asignaciones -->
                        <div class="col-12 col-md-8" id="appAssignmentPanel" style="display: none;">
                            <h6>Asignaciones para: <span id="selectedAppName"></span></h6>

                            <!-- Roles -->
                            <div class="mb-4">
                                <h6 class="text-primary">
                                    <i class="bi bi-people me-1"></i>Roles
                                </h6>
                                <div id="rolesList" class="d-flex flex-wrap gap-2 mb-2">
                                    <small class="text-muted">Cargando...</small>
                                </div>
                                <div class="input-group input-group-sm">
                                    <select class="form-select" id="roleToAssign">
                                        <option value="">Seleccionar rol...</option>
                                        <!-- ⭐ CARGAR ROLES DESDE BACKEND (pasados al template) -->
                                    </select>
                                    <button class="btn btn-primary" id="assignRoleBtn">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Permisos Directos -->
                            <div class="mb-4">
                                <h6 class="text-success">
                                    <i class="bi bi-key me-1"></i>Permisos Directos
                                </h6>
                                <div id="permsList" class="d-flex flex-wrap gap-2 mb-2">
                                    <small class="text-muted">Cargando...</small>
                                </div>
                                <div class="input-group input-group-sm">
                                    <select class="form-select" id="permToAssign">
                                        <option value="">Seleccionar permiso...</option>
                                        <!-- Se llena dinámicamente por app -->
                                    </select>
                                    <button class="btn btn-success" id="assignPermBtn">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Permisos Efectivos -->
                            <div class="border-top pt-3">
                                <h6 class="text-info">
                                    <i class="bi bi-shield-check me-1"></i>Permisos Efectivos
                                </h6>
                                <div id="effectivePermsList" class="d-flex flex-wrap gap-1">
                                    <small class="text-muted">Calculando...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong class="me-auto">Éxito</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage">Operación completada</div>
        </div>

        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-exclamation-circle-fill text-danger me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage">Ha ocurrido un error</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const POSITION_ID = {{ position_id }};
        const AVAILABLE_ROLES = [
            {% for role in roles %}
                { name: "{{ role.name }}" } {% if not loop.last %}, {% endif %}
            {% endfor %}
        ];
    </script>
    <script src="{{ url_for('static', filename='core/js/config/position_detail.js') }}?v={{ static_version }}"></script>
</body>

</html>