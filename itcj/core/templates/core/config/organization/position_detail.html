{% extends "core/config/config_base.html" %}

{% set sidebar_active = 'departments' %}

{% block title %}Detalle del Puesto{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('pages_core.pages_config.positions_management') }}" class="text-decoration-none">
        Departamentos
    </a>
</li>
<li class="breadcrumb-item">
    <a href="#" id="departmentBreadcrumb" class="text-decoration-none">Cargando...</a>
</li>
<li class="breadcrumb-item active" id="positionBreadcrumb">Cargando...</li>
{% endblock %}

{% block page_icon %}<i class="bi bi-briefcase"></i>{% endblock %}
{% block page_title %}<span id="positionName">Cargando...</span>{% endblock %}
{% block page_subtitle %}Codigo: <code id="positionCode">...</code>{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2 flex-wrap">
    <button class="btn btn-outline-danger btn-sm" id="deletePositionBtn">
        <i class="bi bi-trash me-1"></i><span class="d-none d-sm-inline">Eliminar</span>
    </button>
    <button class="btn btn-primary btn-sm" id="savePositionBtn">
        <i class="bi bi-check-lg me-1"></i><span class="d-none d-sm-inline">Guardar</span>
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media (min-width: 576px) {
        #deletePositionBtn, #savePositionBtn {
            font-size: 1rem;
            padding: 0.375rem 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-3 g-lg-4">
    <!-- Informacion General -->
    <div class="col-12 col-lg-6 mb-3 mb-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0 fs-6"><i class="bi bi-info-circle me-2"></i>Informacion General</h5>
            </div>
            <div class="card-body">
                <form id="positionForm">
                    <div class="mb-3">
                        <label for="positionTitleInput" class="form-label">Titulo del Puesto *</label>
                        <input type="text" class="form-control" id="positionTitleInput" required>
                    </div>

                    <div class="mb-3">
                        <label for="positionDescription" class="form-label">Descripcion</label>
                        <textarea class="form-control" id="positionDescription" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="positionEmail" class="form-label">Email Oficial</label>
                        <input type="email" class="form-control" id="positionEmail">
                        <small class="form-text text-muted">Email del puesto (solo para puestos unicos)</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="allowsMultiple">
                            <label class="form-check-label" for="allowsMultiple">
                                Permitir multiples usuarios
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isActive">
                            <label class="form-check-label" for="isActive">
                                Puesto activo
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info py-2" id="codeInfo">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Codigo:</strong> <span id="displayCode"></span>
                        <br>
                        <small>El codigo no puede ser modificado</small>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Usuarios Asignados -->
    <div class="col-12 col-lg-6 mb-3 mb-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0 fs-6"><i class="bi bi-people me-2"></i>Usuarios Asignados</h5>
                <button class="btn btn-sm btn-primary w-100 w-sm-auto" id="assignUserBtn">
                    <i class="bi bi-person-plus me-1"></i><span class="d-none d-sm-inline">Asignar</span><span class="d-sm-none">Asignar Usuario</span>
                </button>
            </div>
            <div class="card-body" id="usersListContainer">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aplicaciones y Permisos -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0 fs-6"><i class="bi bi-app me-2"></i>Aplicaciones y Permisos</h5>
                <button class="btn btn-sm btn-primary w-100 w-sm-auto" id="manageAppsBtn">
                    <i class="bi bi-gear me-1"></i><span class="d-none d-sm-inline">Gestionar Apps</span><span class="d-sm-none">Gestionar Aplicaciones</span>
                </button>
            </div>
            <div class="card-body" id="appsContainer">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal: Asignar Usuario -->
<div class="modal fade" id="assignUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="userSearch" class="form-label">Buscar Usuario</label>
                        <input type="text" class="form-control" id="userSearch" placeholder="Buscar por nombre...">
                    </div>
                    <div class="mb-3">
                        <label for="userSelect" class="form-label">Usuario *</label>
                        <select class="form-select" id="userSelect" required>
                            <option value="">Seleccionar usuario...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Fecha de Inicio</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="mb-3">
                        <label for="assignmentNotes" class="form-label">Notas</label>
                        <textarea class="form-control" id="assignmentNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Asignar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Confirmacion -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirmar Accion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" class="mb-0">Estas seguro de realizar esta accion?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Gestionar Apps/Roles -->
<div class="modal fade" id="manageAppsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-apps me-2"></i>Gestionar Aplicaciones
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Lista de Apps -->
                    <div class="col-12 col-md-4">
                        <h6>Aplicaciones Disponibles</h6>
                        <div class="list-group" id="appsListModal">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel de Asignaciones -->
                    <div class="col-12 col-md-8" id="appAssignmentPanel" style="display: none;">
                        <h6>Asignaciones para: <span id="selectedAppName"></span></h6>

                        <!-- Roles -->
                        <div class="mb-4">
                            <h6 class="text-primary">
                                <i class="bi bi-people me-1"></i>Roles
                            </h6>
                            <div id="rolesList" class="d-flex flex-wrap gap-2 mb-2">
                                <small class="text-muted">Cargando...</small>
                            </div>
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="roleToAssign">
                                    <option value="">Seleccionar rol...</option>
                                </select>
                                <button class="btn btn-primary" id="assignRoleBtn">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Permisos Directos -->
                        <div class="mb-4">
                            <h6 class="text-success">
                                <i class="bi bi-key me-1"></i>Permisos Directos
                            </h6>
                            <div id="permsList" class="d-flex flex-wrap gap-2 mb-2">
                                <small class="text-muted">Cargando...</small>
                            </div>
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="permToAssign">
                                    <option value="">Seleccionar permiso...</option>
                                </select>
                                <button class="btn btn-success" id="assignPermBtn">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Permisos Efectivos -->
                        <div class="border-top pt-3">
                            <h6 class="text-info">
                                <i class="bi bi-shield-check me-1"></i>Permisos Efectivos
                            </h6>
                            <div id="effectivePermsList" class="d-flex flex-wrap gap-1">
                                <small class="text-muted">Calculando...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const POSITION_ID = {{ position_id }};
    const AVAILABLE_ROLES = [
        {% for role in roles %}
            { name: "{{ role.name }}" }{% if not loop.last %}, {% endif %}
        {% endfor %}
    ];
</script>
<script src="{{ url_for('static', filename='core/js/config/organization/position_detail.js') }}?v={{ sv('core', 'js/config/organization/position_detail.js') }}"></script>
{% endblock %}
